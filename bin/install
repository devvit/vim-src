#!/usr/bin/env bash

set -euo pipefail

# 1. 捕获 asdf 环境变量
VERSION="$ASDF_INSTALL_VERSION"
INSTALL_PATH="$ASDF_INSTALL_PATH"

# 2. 自动捕获并构建代理参数
PROXY_ARGS=""
[ -n "${https_proxy:-}" ] && PROXY_ARGS="$PROXY_ARGS -e https_proxy=$https_proxy"
[ -n "${http_proxy:-}" ] && PROXY_ARGS="$PROXY_ARGS -e http_proxy=$http_proxy"

if [[ "$PROXY_ARGS" == *"127.0.0.1"* ]] || [[ "$PROXY_ARGS" == *"localhost"* ]]; then
    NETWORK_MODE="--network host"
else
    NETWORK_MODE=""
fi

echo "--- 开始编译 Vim $VERSION ---"
echo "安装目标: $INSTALL_PATH"

# 3. 创建目标目录（宿主机）
mkdir -p "$INSTALL_PATH"

# 4. 执行 Docker 编译过程
# 关键：将宿主机的 $INSTALL_PATH 映射到容器内完全相同的路径
docker run -i --rm \
    $NETWORK_MODE \
    $PROXY_ARGS \
    -v "$INSTALL_PATH":"$INSTALL_PATH" \
    -w /tmp \
    alpine:3.9 /bin/sh <<EOF
set -e

# 安装依赖
apk add gcc make musl-dev ncurses-static ncurses-dev wget tar

# 下载源码
echo "正在下载源码..."
wget "https://github.com/vim/vim/archive/v${VERSION}.tar.gz" -O vim.tar.gz
tar -xzf vim.tar.gz
cd vim-*

# 配置编译
# --prefix 设置为与宿主机一致的 $INSTALL_PATH
LDFLAGS="-static" ./configure \
    --prefix="$INSTALL_PATH" \
    --disable-nls \
    --disable-gui \
    --enable-multibyte \
    --with-features=huge \
    --without-x \
    --with-tlib=ncursesw

# 编译并安装
make -j\$(nproc)
make install

# 清理符号表减小体积
strip "$INSTALL_PATH/bin/vim"

# 修改权限，确保宿主机用户可写
chown -R $(id -u):$(id -g) "$INSTALL_PATH"
EOF

echo "--- Vim $VERSION 安装成功 ---"
echo "可执行文件位置: $INSTALL_PATH/bin/vim"
